import { c, canvas } from "./constants.js";
import { gameState, GameState } from "./constants.js";
export default class GameHistory {
    constructor({ EndGame_SecondeGame, historyDB }) {
        this.title = "Game History";
        this.tileFont = "bold 40px Black Ops One";
        this.EndGame_SecondeGame = EndGame_SecondeGame;
        this.historyDB = historyDB;
        this.lastGame = null;
        // Chargement immédiat de l'historique depuis la base de données
        this.gameHistory = this.historyDB.getHistory() || [];
        // Vérification si nous avons des données à sauvegarder d'une partie précédente
        if (EndGame_SecondeGame && EndGame_SecondeGame.nb_game > 0) {
            this.saveGameIfNeeded(EndGame_SecondeGame.nb_game, EndGame_SecondeGame.winner, EndGame_SecondeGame.score, EndGame_SecondeGame.time_endGame);
        }
        this.options = ["Retour"];
        this.selectedOption = 0;
        this.optionSpacing = 60;
        this.optionFont = "20px 'Press Start 2P', Black Ops One";
        this.keyPressed = {};
        this.boundKeyDown = this.handleKeyDown.bind(this);
        this.boundKeyUp = this.handleKeyUp.bind(this);
        // Debug
        console.log("GameHistory initialisé, nombre d'entrées:", this.gameHistory.length);
    }
    enableControls() {
        window.addEventListener("keydown", this.boundKeyDown);
        window.addEventListener("keyup", this.boundKeyUp);
    }
    disableControls() {
        window.removeEventListener("keydown", this.boundKeyDown);
        window.removeEventListener("keyup", this.boundKeyUp);
    }
    saveGameIfNeeded(nb_game, winner, score, time_endGame) {
        console.log("saveGameIfNeeded", nb_game, winner, score, time_endGame);
        if (nb_game > 0 && winner !== "" && score > 0) {
            this.historyDB.addGame(nb_game, winner, score, time_endGame);
            this.gameHistory = this.historyDB.getHistory();
            this.historyDB.saveToLocalStorage();
            console.log("Jeu sauvegardé, nombre d'entrées maintenant:", this.gameHistory.length);
        }
    }
    draw() {
        this.enableControls();
        c.fillStyle = "rgba(0, 0, 0, 0.75)";
        c.fillRect(0, 0, canvas.width, canvas.height);
        // Titre
        c.font = this.tileFont;
        c.textAlign = "center";
        c.fillStyle = "#FFD700";
        c.shadowColor = "#000";
        c.shadowBlur = 10;
        c.fillText(this.title, canvas.width / 2, 100);
        c.shadowBlur = 0;
        // Historique
        c.fillStyle = "white";
        c.font = "20px 'Press Start 2P', Black Ops One";
        c.textAlign = "left";
        c.fillText("Game History :", 200, 200);
        // Affichage de l'historique des jeux
        if (this.gameHistory.length > 0) {
            // console.log("Historique des jeux :", this.historyDB.getHistory());
            this.gameHistory.forEach((game, index) => {
                const yPosition = 240 + index * 40; // commence à 240px, et espace de 40px entre chaque
                c.fillText(`${game.game}: Winner: ${game.winner}, Score: ${game.score}`, 400, yPosition);
            });
        }
        else {
            c.fillText("No game history available", 400, 240);
        }
        const optionPositions = [
            { x: 900, y: 550 } // position de "Retour"
        ];
        c.font = this.optionFont;
        this.options.forEach((option, index) => {
            const pos = optionPositions[index];
            if (option === "Retour" && index === this.selectedOption) {
                c.fillStyle = "red"; // Rouge si "Retour" est sélectionné
            }
            else {
                c.fillStyle = "white"; // Sinon blanc
            }
            c.fillText(option, pos.x, pos.y);
            c.fillStyle = "white";
        });
    }
    handleKeyDown(event) {
        const key = event.key;
        if (this.keyPressed[key])
            return;
        this.keyPressed[key] = true;
        switch (key) {
            case "ArrowUp":
            case "w":
                this.selectedOption = (this.selectedOption - 1 + this.options.length) % this.options.length;
                break;
            case "ArrowDown":
            case "s":
                this.selectedOption = (this.selectedOption + 1) % this.options.length;
                break;
            case "Enter":
                this.handleSelect();
                break;
        }
    }
    handleKeyUp(event) {
        this.keyPressed[event.key] = false;
    }
    handleSelect() {
        const selected = this.options[this.selectedOption];
        if (selected === "Retour") {
            this.disableControls();
            gameState.previous = gameState.current;
            gameState.current = GameState.Menu;
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiR2FtZUhpc3RvcnkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wdWJsaWMvc3RhdGljL2pzL3ZpZXdzL3BsYXRmb3JtZXIvR2FtZUhpc3RvcnkuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLENBQUMsRUFBRSxNQUFNLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMzQyxPQUFPLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXRELE1BQU0sQ0FBQyxPQUFPLE9BQU8sV0FBVztJQUMvQixZQUFZLEVBQUUsbUJBQW1CLEVBQUUsU0FBUyxFQUFFO1FBQzdDLElBQUksQ0FBQyxLQUFLLEdBQUcsY0FBYyxDQUFDO1FBQzVCLElBQUksQ0FBQyxRQUFRLEdBQUcseUJBQXlCLENBQUM7UUFDMUMsSUFBSSxDQUFDLG1CQUFtQixHQUFHLG1CQUFtQixDQUFDO1FBQy9DLElBQUksQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDO1FBQzNCLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO1FBRXJCLGdFQUFnRTtRQUNoRSxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsVUFBVSxFQUFFLElBQUksRUFBRSxDQUFDO1FBRXJELCtFQUErRTtRQUMvRSxJQUFJLG1CQUFtQixJQUFJLG1CQUFtQixDQUFDLE9BQU8sR0FBRyxDQUFDLEVBQUUsQ0FBQztZQUM1RCxJQUFJLENBQUMsZ0JBQWdCLENBQ3BCLG1CQUFtQixDQUFDLE9BQU8sRUFDM0IsbUJBQW1CLENBQUMsTUFBTSxFQUMxQixtQkFBbUIsQ0FBQyxLQUFLLEVBQ3pCLG1CQUFtQixDQUFDLFlBQVksQ0FDaEMsQ0FBQztRQUNILENBQUM7UUFFRCxJQUFJLENBQUMsT0FBTyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDMUIsSUFBSSxDQUFDLGNBQWMsR0FBRyxDQUFDLENBQUM7UUFDeEIsSUFBSSxDQUFDLGFBQWEsR0FBRyxFQUFFLENBQUM7UUFDeEIsSUFBSSxDQUFDLFVBQVUsR0FBRyxzQ0FBc0MsQ0FBQztRQUV6RCxJQUFJLENBQUMsVUFBVSxHQUFHLEVBQUUsQ0FBQztRQUNyQixJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2xELElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFOUMsUUFBUTtRQUNSLE9BQU8sQ0FBQyxHQUFHLENBQUMsMkNBQTJDLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNuRixDQUFDO0lBRUQsY0FBYztRQUNiLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQ3RELE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ25ELENBQUM7SUFFRCxlQUFlO1FBQ2QsTUFBTSxDQUFDLG1CQUFtQixDQUFDLFNBQVMsRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDekQsTUFBTSxDQUFDLG1CQUFtQixDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDdEQsQ0FBQztJQUVELGdCQUFnQixDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLFlBQVk7UUFDcEQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxZQUFZLENBQUMsQ0FBQztRQUN0RSxJQUFJLE9BQU8sR0FBRyxDQUFDLElBQUksTUFBTSxLQUFLLEVBQUUsSUFBSSxLQUFLLEdBQUcsQ0FBQyxFQUFFLENBQUM7WUFDL0MsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsWUFBWSxDQUFDLENBQUM7WUFDN0QsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsRUFBRSxDQUFDO1lBQy9DLElBQUksQ0FBQyxTQUFTLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztZQUNwQyxPQUFPLENBQUMsR0FBRyxDQUFDLDhDQUE4QyxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDdEYsQ0FBQztJQUNGLENBQUM7SUFFRCxJQUFJO1FBQ0gsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBQ3RCLENBQUMsQ0FBQyxTQUFTLEdBQUcscUJBQXFCLENBQUM7UUFDcEMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxLQUFLLEVBQUUsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRTlDLFFBQVE7UUFDUixDQUFDLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUM7UUFDdkIsQ0FBQyxDQUFDLFNBQVMsR0FBRyxRQUFRLENBQUM7UUFDdkIsQ0FBQyxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7UUFDeEIsQ0FBQyxDQUFDLFdBQVcsR0FBRyxNQUFNLENBQUM7UUFDdkIsQ0FBQyxDQUFDLFVBQVUsR0FBRyxFQUFFLENBQUM7UUFDbEIsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLE1BQU0sQ0FBQyxLQUFLLEdBQUcsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQzlDLENBQUMsQ0FBQyxVQUFVLEdBQUcsQ0FBQyxDQUFDO1FBRWpCLGFBQWE7UUFDYixDQUFDLENBQUMsU0FBUyxHQUFHLE9BQU8sQ0FBQztRQUN0QixDQUFDLENBQUMsSUFBSSxHQUFHLHNDQUFzQyxDQUFDO1FBQ2hELENBQUMsQ0FBQyxTQUFTLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLENBQUMsQ0FBQyxRQUFRLENBQUMsZ0JBQWdCLEVBQUUsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBR3ZDLHFDQUFxQztRQUVyQyxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQ2pDLHFFQUFxRTtZQUNyRSxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsRUFBRTtnQkFFeEMsTUFBTSxTQUFTLEdBQUcsR0FBRyxHQUFHLEtBQUssR0FBRyxFQUFFLENBQUMsQ0FBQyxtREFBbUQ7Z0JBQ3ZGLENBQUMsQ0FBQyxRQUFRLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxhQUFhLElBQUksQ0FBQyxNQUFNLFlBQVksSUFBSSxDQUFDLEtBQUssRUFBRSxFQUFFLEdBQUcsRUFBRSxTQUFTLENBQUMsQ0FBQztZQUMxRixDQUFDLENBQUMsQ0FBQztRQUNKLENBQUM7YUFBTSxDQUFDO1lBQ1AsQ0FBQyxDQUFDLFFBQVEsQ0FBQywyQkFBMkIsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDbkQsQ0FBQztRQUVELE1BQU0sZUFBZSxHQUFHO1lBQ3ZCLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUMsdUJBQXVCO1NBQzFDLENBQUM7UUFFRixDQUFDLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUM7UUFFekIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxNQUFNLEVBQUUsS0FBSyxFQUFFLEVBQUU7WUFDdEMsTUFBTSxHQUFHLEdBQUcsZUFBZSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ25DLElBQUksTUFBTSxLQUFLLFFBQVEsSUFBSSxLQUFLLEtBQUssSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO2dCQUMxRCxDQUFDLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQyxDQUFDLG9DQUFvQztZQUMxRCxDQUFDO2lCQUNJLENBQUM7Z0JBQ0wsQ0FBQyxDQUFDLFNBQVMsR0FBRyxPQUFPLENBQUMsQ0FBQyxjQUFjO1lBQ3RDLENBQUM7WUFDRCxDQUFDLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNqQyxDQUFDLENBQUMsU0FBUyxHQUFHLE9BQU8sQ0FBQztRQUN2QixDQUFDLENBQUMsQ0FBQztJQUNKLENBQUM7SUFFRCxhQUFhLENBQUMsS0FBSztRQUNsQixNQUFNLEdBQUcsR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDO1FBQ3RCLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUM7WUFBRSxPQUFPO1FBQ2pDLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDO1FBRTVCLFFBQVEsR0FBRyxFQUFFLENBQUM7WUFDYixLQUFLLFNBQVMsQ0FBQztZQUNmLEtBQUssR0FBRztnQkFDUCxJQUFJLENBQUMsY0FBYyxHQUFHLENBQUMsSUFBSSxDQUFDLGNBQWMsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQztnQkFDNUYsTUFBTTtZQUNQLEtBQUssV0FBVyxDQUFDO1lBQ2pCLEtBQUssR0FBRztnQkFDUCxJQUFJLENBQUMsY0FBYyxHQUFHLENBQUMsSUFBSSxDQUFDLGNBQWMsR0FBRyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQztnQkFDdEUsTUFBTTtZQUNQLEtBQUssT0FBTztnQkFDWCxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7Z0JBQ3BCLE1BQU07UUFDUixDQUFDO0lBQ0YsQ0FBQztJQUVELFdBQVcsQ0FBQyxLQUFLO1FBQ2hCLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEtBQUssQ0FBQztJQUNwQyxDQUFDO0lBRUQsWUFBWTtRQUNYLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBQ25ELElBQUksUUFBUSxLQUFLLFFBQVEsRUFBRSxDQUFDO1lBQzNCLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztZQUN2QixTQUFTLENBQUMsUUFBUSxHQUFHLFNBQVMsQ0FBQyxPQUFPLENBQUM7WUFDdkMsU0FBUyxDQUFDLE9BQU8sR0FBRyxTQUFTLENBQUMsSUFBSSxDQUFDO1FBQ3BDLENBQUM7SUFDRixDQUFDO0NBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBjLCBjYW52YXMgfSBmcm9tIFwiLi9jb25zdGFudHMuanNcIjtcbmltcG9ydCB7IGdhbWVTdGF0ZSwgR2FtZVN0YXRlIH0gZnJvbSBcIi4vY29uc3RhbnRzLmpzXCI7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEdhbWVIaXN0b3J5IHtcblx0Y29uc3RydWN0b3IoeyBFbmRHYW1lX1NlY29uZGVHYW1lLCBoaXN0b3J5REIgfSkge1xuXHRcdHRoaXMudGl0bGUgPSBcIkdhbWUgSGlzdG9yeVwiO1xuXHRcdHRoaXMudGlsZUZvbnQgPSBcImJvbGQgNDBweCBCbGFjayBPcHMgT25lXCI7XG5cdFx0dGhpcy5FbmRHYW1lX1NlY29uZGVHYW1lID0gRW5kR2FtZV9TZWNvbmRlR2FtZTtcblx0XHR0aGlzLmhpc3RvcnlEQiA9IGhpc3RvcnlEQjtcblx0XHR0aGlzLmxhc3RHYW1lID0gbnVsbDtcbiAgICAgICAgXG5cdFx0Ly8gQ2hhcmdlbWVudCBpbW3DqWRpYXQgZGUgbCdoaXN0b3JpcXVlIGRlcHVpcyBsYSBiYXNlIGRlIGRvbm7DqWVzXG5cdFx0dGhpcy5nYW1lSGlzdG9yeSA9IHRoaXMuaGlzdG9yeURCLmdldEhpc3RvcnkoKSB8fCBbXTtcbiAgICAgICAgXG5cdFx0Ly8gVsOpcmlmaWNhdGlvbiBzaSBub3VzIGF2b25zIGRlcyBkb25uw6llcyDDoCBzYXV2ZWdhcmRlciBkJ3VuZSBwYXJ0aWUgcHLDqWPDqWRlbnRlXG5cdFx0aWYgKEVuZEdhbWVfU2Vjb25kZUdhbWUgJiYgRW5kR2FtZV9TZWNvbmRlR2FtZS5uYl9nYW1lID4gMCkge1xuXHRcdFx0dGhpcy5zYXZlR2FtZUlmTmVlZGVkKFxuXHRcdFx0XHRFbmRHYW1lX1NlY29uZGVHYW1lLm5iX2dhbWUsXG5cdFx0XHRcdEVuZEdhbWVfU2Vjb25kZUdhbWUud2lubmVyLFxuXHRcdFx0XHRFbmRHYW1lX1NlY29uZGVHYW1lLnNjb3JlLFxuXHRcdFx0XHRFbmRHYW1lX1NlY29uZGVHYW1lLnRpbWVfZW5kR2FtZVxuXHRcdFx0KTtcblx0XHR9XG5cblx0XHR0aGlzLm9wdGlvbnMgPSBbXCJSZXRvdXJcIl07XG5cdFx0dGhpcy5zZWxlY3RlZE9wdGlvbiA9IDA7XG5cdFx0dGhpcy5vcHRpb25TcGFjaW5nID0gNjA7XG5cdFx0dGhpcy5vcHRpb25Gb250ID0gXCIyMHB4ICdQcmVzcyBTdGFydCAyUCcsIEJsYWNrIE9wcyBPbmVcIjtcblxuXHRcdHRoaXMua2V5UHJlc3NlZCA9IHt9O1xuXHRcdHRoaXMuYm91bmRLZXlEb3duID0gdGhpcy5oYW5kbGVLZXlEb3duLmJpbmQodGhpcyk7XG5cdFx0dGhpcy5ib3VuZEtleVVwID0gdGhpcy5oYW5kbGVLZXlVcC5iaW5kKHRoaXMpO1xuICAgICAgICBcblx0XHQvLyBEZWJ1Z1xuXHRcdGNvbnNvbGUubG9nKFwiR2FtZUhpc3RvcnkgaW5pdGlhbGlzw6ksIG5vbWJyZSBkJ2VudHLDqWVzOlwiLCB0aGlzLmdhbWVIaXN0b3J5Lmxlbmd0aCk7XG5cdH1cblxuXHRlbmFibGVDb250cm9scygpIHtcblx0XHR3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcihcImtleWRvd25cIiwgdGhpcy5ib3VuZEtleURvd24pO1xuXHRcdHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKFwia2V5dXBcIiwgdGhpcy5ib3VuZEtleVVwKTtcblx0fVxuXG5cdGRpc2FibGVDb250cm9scygpIHtcblx0XHR3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcihcImtleWRvd25cIiwgdGhpcy5ib3VuZEtleURvd24pO1xuXHRcdHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKFwia2V5dXBcIiwgdGhpcy5ib3VuZEtleVVwKTtcblx0fVxuXHRcblx0c2F2ZUdhbWVJZk5lZWRlZChuYl9nYW1lLCB3aW5uZXIsIHNjb3JlLCB0aW1lX2VuZEdhbWUpIHtcblx0XHRjb25zb2xlLmxvZyhcInNhdmVHYW1lSWZOZWVkZWRcIiwgbmJfZ2FtZSwgd2lubmVyLCBzY29yZSwgdGltZV9lbmRHYW1lKTtcblx0XHRpZiAobmJfZ2FtZSA+IDAgJiYgd2lubmVyICE9PSBcIlwiICYmIHNjb3JlID4gMCkge1xuXHRcdFx0dGhpcy5oaXN0b3J5REIuYWRkR2FtZShuYl9nYW1lLCB3aW5uZXIsIHNjb3JlLCB0aW1lX2VuZEdhbWUpO1xuXHRcdFx0dGhpcy5nYW1lSGlzdG9yeSA9IHRoaXMuaGlzdG9yeURCLmdldEhpc3RvcnkoKTtcblx0XHRcdHRoaXMuaGlzdG9yeURCLnNhdmVUb0xvY2FsU3RvcmFnZSgpO1xuXHRcdFx0Y29uc29sZS5sb2coXCJKZXUgc2F1dmVnYXJkw6ksIG5vbWJyZSBkJ2VudHLDqWVzIG1haW50ZW5hbnQ6XCIsIHRoaXMuZ2FtZUhpc3RvcnkubGVuZ3RoKTtcblx0XHR9XG5cdH1cblxuXHRkcmF3KCkge1xuXHRcdHRoaXMuZW5hYmxlQ29udHJvbHMoKTtcblx0XHRjLmZpbGxTdHlsZSA9IFwicmdiYSgwLCAwLCAwLCAwLjc1KVwiO1xuXHRcdGMuZmlsbFJlY3QoMCwgMCwgY2FudmFzLndpZHRoLCBjYW52YXMuaGVpZ2h0KTtcblxuXHRcdC8vIFRpdHJlXG5cdFx0Yy5mb250ID0gdGhpcy50aWxlRm9udDtcblx0XHRjLnRleHRBbGlnbiA9IFwiY2VudGVyXCI7XG5cdFx0Yy5maWxsU3R5bGUgPSBcIiNGRkQ3MDBcIjtcblx0XHRjLnNoYWRvd0NvbG9yID0gXCIjMDAwXCI7XG5cdFx0Yy5zaGFkb3dCbHVyID0gMTA7XG5cdFx0Yy5maWxsVGV4dCh0aGlzLnRpdGxlLCBjYW52YXMud2lkdGggLyAyLCAxMDApO1xuXHRcdGMuc2hhZG93Qmx1ciA9IDA7XG5cblx0XHQvLyBIaXN0b3JpcXVlXG5cdFx0Yy5maWxsU3R5bGUgPSBcIndoaXRlXCI7XG5cdFx0Yy5mb250ID0gXCIyMHB4ICdQcmVzcyBTdGFydCAyUCcsIEJsYWNrIE9wcyBPbmVcIjtcblx0XHRjLnRleHRBbGlnbiA9IFwibGVmdFwiO1xuXHRcdGMuZmlsbFRleHQoXCJHYW1lIEhpc3RvcnkgOlwiLCAyMDAsIDIwMCk7XG5cblxuXHRcdC8vIEFmZmljaGFnZSBkZSBsJ2hpc3RvcmlxdWUgZGVzIGpldXhcblxuXHRcdGlmICh0aGlzLmdhbWVIaXN0b3J5Lmxlbmd0aCA+IDApIHtcblx0XHRcdC8vIGNvbnNvbGUubG9nKFwiSGlzdG9yaXF1ZSBkZXMgamV1eCA6XCIsIHRoaXMuaGlzdG9yeURCLmdldEhpc3RvcnkoKSk7XG5cdFx0XHR0aGlzLmdhbWVIaXN0b3J5LmZvckVhY2goKGdhbWUsIGluZGV4KSA9PiB7XG5cblx0XHRcdFx0Y29uc3QgeVBvc2l0aW9uID0gMjQwICsgaW5kZXggKiA0MDsgLy8gY29tbWVuY2Ugw6AgMjQwcHgsIGV0IGVzcGFjZSBkZSA0MHB4IGVudHJlIGNoYXF1ZVxuXHRcdFx0XHRjLmZpbGxUZXh0KGAke2dhbWUuZ2FtZX06IFdpbm5lcjogJHtnYW1lLndpbm5lcn0sIFNjb3JlOiAke2dhbWUuc2NvcmV9YCwgNDAwLCB5UG9zaXRpb24pO1xuXHRcdFx0fSk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdGMuZmlsbFRleHQoXCJObyBnYW1lIGhpc3RvcnkgYXZhaWxhYmxlXCIsIDQwMCwgMjQwKTtcblx0XHR9XG5cblx0XHRjb25zdCBvcHRpb25Qb3NpdGlvbnMgPSBbXG5cdFx0XHR7IHg6IDkwMCwgeTogNTUwIH0gLy8gcG9zaXRpb24gZGUgXCJSZXRvdXJcIlxuXHRcdF07XG5cdFxuXHRcdGMuZm9udCA9IHRoaXMub3B0aW9uRm9udDtcblxuXHRcdHRoaXMub3B0aW9ucy5mb3JFYWNoKChvcHRpb24sIGluZGV4KSA9PiB7XG5cdFx0XHRjb25zdCBwb3MgPSBvcHRpb25Qb3NpdGlvbnNbaW5kZXhdO1xuXHRcdFx0aWYgKG9wdGlvbiA9PT0gXCJSZXRvdXJcIiAmJiBpbmRleCA9PT0gdGhpcy5zZWxlY3RlZE9wdGlvbikge1xuXHRcdFx0XHRjLmZpbGxTdHlsZSA9IFwicmVkXCI7IC8vIFJvdWdlIHNpIFwiUmV0b3VyXCIgZXN0IHPDqWxlY3Rpb25uw6lcblx0XHRcdH1cblx0XHRcdGVsc2Uge1xuXHRcdFx0XHRjLmZpbGxTdHlsZSA9IFwid2hpdGVcIjsgLy8gU2lub24gYmxhbmNcblx0XHRcdH1cblx0XHRcdGMuZmlsbFRleHQob3B0aW9uLCBwb3MueCwgcG9zLnkpO1xuXHRcdFx0Yy5maWxsU3R5bGUgPSBcIndoaXRlXCI7XG5cdFx0fSk7XG5cdH1cblxuXHRoYW5kbGVLZXlEb3duKGV2ZW50KSB7XG5cdFx0Y29uc3Qga2V5ID0gZXZlbnQua2V5O1xuXHRcdGlmICh0aGlzLmtleVByZXNzZWRba2V5XSkgcmV0dXJuO1xuXHRcdHRoaXMua2V5UHJlc3NlZFtrZXldID0gdHJ1ZTtcblxuXHRcdHN3aXRjaCAoa2V5KSB7XG5cdFx0XHRjYXNlIFwiQXJyb3dVcFwiOlxuXHRcdFx0Y2FzZSBcIndcIjpcblx0XHRcdFx0dGhpcy5zZWxlY3RlZE9wdGlvbiA9ICh0aGlzLnNlbGVjdGVkT3B0aW9uIC0gMSArIHRoaXMub3B0aW9ucy5sZW5ndGgpICUgdGhpcy5vcHRpb25zLmxlbmd0aDtcblx0XHRcdFx0YnJlYWs7XG5cdFx0XHRjYXNlIFwiQXJyb3dEb3duXCI6XG5cdFx0XHRjYXNlIFwic1wiOlxuXHRcdFx0XHR0aGlzLnNlbGVjdGVkT3B0aW9uID0gKHRoaXMuc2VsZWN0ZWRPcHRpb24gKyAxKSAlIHRoaXMub3B0aW9ucy5sZW5ndGg7XG5cdFx0XHRcdGJyZWFrO1xuXHRcdFx0Y2FzZSBcIkVudGVyXCI6XG5cdFx0XHRcdHRoaXMuaGFuZGxlU2VsZWN0KCk7XG5cdFx0XHRcdGJyZWFrO1xuXHRcdH1cblx0fVxuXG5cdGhhbmRsZUtleVVwKGV2ZW50KSB7XG5cdFx0dGhpcy5rZXlQcmVzc2VkW2V2ZW50LmtleV0gPSBmYWxzZTtcblx0fVxuXG5cdGhhbmRsZVNlbGVjdCgpIHtcblx0XHRjb25zdCBzZWxlY3RlZCA9IHRoaXMub3B0aW9uc1t0aGlzLnNlbGVjdGVkT3B0aW9uXTtcblx0XHRpZiAoc2VsZWN0ZWQgPT09IFwiUmV0b3VyXCIpIHtcblx0XHRcdHRoaXMuZGlzYWJsZUNvbnRyb2xzKCk7XG5cdFx0XHRnYW1lU3RhdGUucHJldmlvdXMgPSBnYW1lU3RhdGUuY3VycmVudDtcblx0XHRcdGdhbWVTdGF0ZS5jdXJyZW50ID0gR2FtZVN0YXRlLk1lbnU7XG5cdFx0fVxuXHR9XG59Il19