import { c, canvas, gameState, GameState } from './constants.js';
import Sprite from './Sprite.js';
export default class GameCanvas extends Sprite {
    constructor({ position, Image_src_prefix, player }) {
        super({ position, Image_src: Image_src_prefix + "coin_0.png", scaleX: 0.6, scaleY: 0.6 });
        this.coin_icon = new Image();
        this.coin_icon.src = "/srcs/game/assets/City/coin_0.png";
        this.coin_icon_loaded = false;
        this.coin_icon.onload = () => {
            this.coin_icon_loaded = true;
        };
        this.coin_icon_error = false;
        this.coin_icon.onerror = () => {
            this.coin_icon_error = true;
            console.error("Failed to load coin icon");
        };
        this.nb_coin = 0;
        this.nb_coin_text = this.nb_coin + " / 3";
        this.position = position;
        this.Image_src_prefix = Image_src_prefix;
        this.frames = 0;
        this.frameSpeed = 10;
        this.currentSprite = 0;
        this.totalSprites = 8;
        this.state = "idle";
        this.timer_icon = new Image();
        this.timer_icon.src = "/srcs/game/assets/City/timer.png";
        this.timer_icon_loaded = false;
        this.timer_icon.onload = () => {
            this.timer_icon_loaded = true;
        };
        this.timer_icon_error = false;
        this.timer_icon.onerror = () => {
            this.timer_icon_error = true;
            console.error("Failed to load timer icon");
        };
        this.timer = 0;
        this.timer_text = this.timer;
        this.timer_text = "0 s";
        this.lastTime = Date.now();
        this.end_come = false;
        this.GameIsPaused = false;
        this.selectedOption = 0;
        this.options = ["Menu"];
        this.keyPressed = {};
        this.boundKeyDown = this.handleKeyDown.bind(this);
        this.boundKeyUp = this.handleKeyUp.bind(this);
        this.player = player;
    }
    enableControls() {
        window.addEventListener("keydown", this.boundKeyDown);
        window.addEventListener("keyup", this.boundKeyUp);
    }
    disableControls() {
        window.removeEventListener("keydown", this.boundKeyDown);
        window.removeEventListener("keyup", this.boundKeyUp);
    }
    changeSprite() {
        if (this.frames % this.frameSpeed === 0) {
            this.currentSprite++;
            if (this.currentSprite >= this.totalSprites) {
                this.currentSprite = 0;
            }
            let newImg = new Image();
            newImg.src = this.Image_src_prefix + "coin_" + this.currentSprite + ".png";
            this.image = newImg;
        }
        this.frames = (this.frames + 1) % 1000;
    }
    update() {
        const now = Date.now();
        if (now - this.lastTime >= 1000 && this.timer < 300 && !this.GameIsPaused) { // ‚è±Ô∏è une seconde est pass√©e, et max 5 min (300 s)
            this.timer++;
            this.lastTime = now;
            console.log("Timer:", this.timer);
            if (this.timer >= 290)
                this.end_come = true; // ‚è±Ô∏è fin du timer
            else
                this.end_come = false; // ‚è±Ô∏è fin du timer
            if (this.timer >= 300) {
                console.log("Timer finished");
                this.timer = 0;
            }
        }
        this.changeSprite();
        this.draw();
        this.draw_canvas();
        if (this.GameIsPaused) {
            this.draw_menu_pause();
        }
    }
    draw_canvas() {
        // if (this.coin_icon_loaded && !this.coin_icon_error) {
        // 	c.drawImage(this.coin_icon, 8, 8, 30, 30);
        // } else {
        // 	console.error("Coin icon not loaded");
        // }
        // console.log("Coin icon loaded:", this.coin_icon_loaded);
        // console.log("nb_coin:", this.nb_coin);
        this.enableControls();
        if (this.timer_icon_loaded && !this.timer_icon_error) {
            c.drawImage(this.timer_icon, 3, 50, 40, 40);
        }
        else {
            console.error("Timer icon not loaded");
        }
        this.nb_coin_text = this.nb_coin + " / 3";
        c.fillStyle = "gold";
        c.font = "20px 'Press Start 2P', Black Ops One";
        c.fillText(this.nb_coin_text, 70, 30);
        this.timer_text = this.timer + " s";
        if (this.end_come) {
            c.fillStyle = "red";
        }
        else {
            c.fillStyle = "white";
        }
        c.font = "20px 'Press Start 2P', Black Ops One";
        c.fillText(this.timer_text, 70, 75);
    }
    draw_menu_pause() {
        c.save(); // üî• Sauvegarde l'√©tat actuel du canvas
        c.fillStyle = "rgba(0, 0, 0, 0.5)";
        c.fillRect(0, 0, canvas.width, canvas.height);
        c.font = "20px 'Press Start 2P', Black Ops One";
        c.textAlign = "left";
        c.fillStyle = "#FFD700";
        c.shadowColor = "#000";
        c.shadowBlur = 10;
        c.fillText("Pause", 480, 50);
        c.fillStyle = "red";
        c.font = "20px 'Press Start 2P', Black Ops One";
        c.fillText("Menu", 900, 550);
        c.fillStyle = "white";
        c.restore(); // üî• Restaure l'√©tat du canvas
    }
    resetGame() {
        this.nb_coin = 0;
        this.nb_coin_text = this.nb_coin + " / 3";
        this.timer = 0;
        this.timer_text = this.timer;
        this.lastTime = Date.now(); // ‚è±Ô∏è init du timer
        this.end_come = false; // ‚è±Ô∏è fin du timer
    }
    handleKeyDown(event) {
        const key = event.key;
        if (this.keyPressed[key])
            return;
        this.keyPressed[key] = true;
        switch (key) {
            case "ArrowUp":
            case "w":
                this.selectedOption = (this.selectedOption - 1 + this.options.length) % this.options.length;
                break;
            case "ArrowDown":
            case "s":
                this.selectedOption = (this.selectedOption + 1) % this.options.length;
                break;
            case "Enter":
                if (this.GameIsPaused) {
                    this.handleSelect();
                }
                break;
            case "Escape":
                if (gameState.current === GameState.Play) {
                    this.GameIsPaused = !this.GameIsPaused;
                    if (this.GameIsPaused) {
                        console.log("Game paused");
                        this.disableControls();
                    }
                    else {
                        console.log("Game resumed");
                        this.enableControls();
                    }
                }
                break;
        }
    }
    handleKeyUp(event) {
        this.keyPressed[event.key] = false;
    }
    handleSelect() {
        const selected = this.options[this.selectedOption];
        if (selected === "Menu") {
            this.disableControls();
            this.resetGame();
            this.player.reset_Game();
            this.GameIsPaused = false;
            gameState.previous = gameState.current;
            gameState.current = GameState.Menu;
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiR2FtZV9jYW52YXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wdWJsaWMvc3RhdGljL2pzL3ZpZXdzL3BsYXRmb3JtZXIvR2FtZV9jYW52YXMuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLENBQUMsRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ2pFLE9BQU8sTUFBTSxNQUFNLGFBQWEsQ0FBQztBQUVqQyxNQUFNLENBQUMsT0FBTyxPQUFPLFVBQVcsU0FBUSxNQUFNO0lBQzdDLFlBQVksRUFBQyxRQUFRLEVBQUcsZ0JBQWdCLEVBQUUsTUFBTSxFQUFDO1FBQ2hELEtBQUssQ0FBQyxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsZ0JBQWdCLEdBQUcsWUFBWSxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7UUFDMUYsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLEtBQUssRUFBRSxDQUFDO1FBQzdCLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxHQUFHLG1DQUFtQyxDQUFDO1FBQ3pELElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxLQUFLLENBQUM7UUFDOUIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLEdBQUcsR0FBRyxFQUFFO1lBQzVCLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLENBQUM7UUFDOUIsQ0FBQyxDQUFDO1FBQ0YsSUFBSSxDQUFDLGVBQWUsR0FBRyxLQUFLLENBQUM7UUFDN0IsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLEdBQUcsR0FBRyxFQUFFO1lBQzdCLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDO1lBQzVCLE9BQU8sQ0FBQyxLQUFLLENBQUMsMEJBQTBCLENBQUMsQ0FBQztRQUMzQyxDQUFDLENBQUM7UUFFRixJQUFJLENBQUMsT0FBTyxHQUFHLENBQUMsQ0FB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dkIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsQ0FBQzt3QkFDM0IsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO29CQUN4QixDQUFDO3lCQUFNLENBQUM7d0JBQ1AsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsQ0FBQzt3QkFDNUIsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO29CQUN2QixDQUFDO2dCQUNGLENBQUM7Z0JBQ0QsTUFBTTtRQUNSLENBQUM7SUFDRixDQUFDO0lBRUQsV0FBVyxDQUFDLEtBQUs7UUFDaEIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsS0FBSyxDQUFDO0lBQ3BDLENBQUM7SUFFRCxZQUFZO1FBRVgsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUM7UUFDbkQsSUFBSSxRQUFRLEtBQUssTUFBTSxFQUN2QixDQUFDO1lBQ0EsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO1lBQ3ZCLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztZQUNqQixJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsRUFBRSxDQUFDO1lBQ3pCLElBQUksQ0FBQyxZQUFZLEdBQUcsS0FBSyxDQUFDO1lBQzFCLFNBQVMsQ0FBQyxRQUFRLEdBQUcsU0FBUyxDQUFDLE9BQU8sQ0FBQztZQUN2QyxTQUFTLENBQUMsT0FBTyxHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUM7UUFDcEMsQ0FBQztJQUNGLENBQUM7Q0FDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGMsIGNhbnZhcywgZ2FtZVN0YXRlLCBHYW1lU3RhdGUgfSBmcm9tICcuL2NvbnN0YW50cy5qcyc7XG5pbXBvcnQgU3ByaXRlIGZyb20gJy4vU3ByaXRlLmpzJztcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgR2FtZUNhbnZhcyBleHRlbmRzIFNwcml0ZSB7XG5cdGNvbnN0cnVjdG9yKHtwb3NpdGlvbiwgIEltYWdlX3NyY19wcmVmaXgsIHBsYXllcn0pIHtcblx0XHRzdXBlcih7IHBvc2l0aW9uLCBJbWFnZV9zcmM6IEltYWdlX3NyY19wcmVmaXggKyBcImNvaW5fMC5wbmdcIiwgc2NhbGVYOiAwLjYsIHNjYWxlWTogMC42IH0pO1xuXHRcdHRoaXMuY29pbl9pY29uID0gbmV3IEltYWdlKCk7XG5cdFx0dGhpcy5jb2luX2ljb24uc3JjID0gXCIvc3Jjcy9nYW1lL2Fzc2V0cy9DaXR5L2NvaW5fMC5wbmdcIjtcblx0XHR0aGlzLmNvaW5faWNvbl9sb2FkZWQgPSBmYWxzZTtcblx0XHR0aGlzLmNvaW5faWNvbi5vbmxvYWQgPSAoKSA9PiB7XG5cdFx0XHR0aGlzLmNvaW5faWNvbl9sb2FkZWQgPSB0cnVlO1xuXHRcdH07XG5cdFx0dGhpcy5jb2luX2ljb25fZXJyb3IgPSBmYWxzZTtcblx0XHR0aGlzLmNvaW5faWNvbi5vbmVycm9yID0gKCkgPT4ge1xuXHRcdFx0dGhpcy5jb2luX2ljb25fZXJyb3IgPSB0cnVlO1xuXHRcdFx0Y29uc29sZS5lcnJvcihcIkZhaWxlZCB0byBsb2FkIGNvaW4gaWNvblwiKTtcblx0XHR9O1xuXG5cdFx0dGhpcy5uYl9jb2luID0gMDtcblx0XHR0aGlzLm5iX2NvaW5fdGV4dCA9IHRoaXMubmJfY29pbiArIFwiIC8gM1wiO1xuXG5cblx0XHR0aGlzLnBvc2l0aW9uID0gcG9zaXRpb247XG5cdFx0dGhpcy5JbWFnZV9zcmNfcHJlZml4ID0gSW1hZ2Vfc3JjX3ByZWZpeDtcblx0XHR0aGlzLmZyYW1lcyA9IDA7XG5cdFx0dGhpcy5mcmFtZVNwZWVkID0gMTA7XG5cdFx0dGhpcy5jdXJyZW50U3ByaXRlID0gMDtcblx0XHR0aGlzLnRvdGFsU3ByaXRlcyA9IDg7XG5cdFx0dGhpcy5zdGF0ZSA9IFwiaWRsZVwiO1xuXG5cdFx0dGhpcy50aW1lcl9pY29uID0gbmV3IEltYWdlKCk7XG5cdFx0dGhpcy50aW1lcl9pY29uLnNyYyA9IFwiL3NyY3MvZ2FtZS9hc3NldHMvQ2l0eS90aW1lci5wbmdcIjtcblx0XHR0aGlzLnRpbWVyX2ljb25fbG9hZGVkID0gZmFsc2U7XG5cdFx0dGhpcy50aW1lcl9pY29uLm9ubG9hZCA9ICgpID0+IHtcblx0XHRcdHRoaXMudGltZXJfaWNvbl9sb2FkZWQgPSB0cnVlO1xuXHRcdH07XG5cdFx0dGhpcy50aW1lcl9pY29uX2Vycm9yID0gZmFsc2U7XG5cdFx0dGhpcy50aW1lcl9pY29uLm9uZXJyb3IgPSAoKSA9PiB7XG5cdFx0XHR0aGlzLnRpbWVyX2ljb25fZXJyb3IgPSB0cnVlO1xuXHRcdFx0Y29uc29sZS5lcnJvcihcIkZhaWxlZCB0byBsb2FkIHRpbWVyIGljb25cIik7XG5cdFx0fTtcblx0XHR0aGlzLnRpbWVyID0gMDtcblx0XHR0aGlzLnRpbWVyX3RleHQgPSB0aGlzLnRpbWVyO1xuXHRcdHRoaXMudGltZXJfdGV4dCA9IFwiMCBzXCI7XG5cdFx0dGhpcy5sYXN0VGltZSA9IERhdGUubm93KCk7XG5cdFx0dGhpcy5lbmRfY29tZSA9IGZhbHNlO1xuXHRcdHRoaXMuR2FtZUlzUGF1c2VkID0gZmFsc2U7XG5cblx0XHR0aGlzLnNlbGVjdGVkT3B0aW9uID0gMDtcblx0XHR0aGlzLm9wdGlvbnMgPSBbXCJNZW51XCJdO1xuXG5cdFx0dGhpcy5rZXlQcmVzc2VkID0ge307XG5cdFx0dGhpcy5ib3VuZEtleURvd24gPSB0aGlzLmhhbmRsZUtleURvd24uYmluZCh0aGlzKTtcblx0XHR0aGlzLmJvdW5kS2V5VXAgPSB0aGlzLmhhbmRsZUtleVVwLmJpbmQodGhpcyk7XG5cdFx0dGhpcy5wbGF5ZXIgPSBwbGF5ZXI7XG5cdH1cblxuXHRlbmFibGVDb250cm9scygpIHtcblx0XHR3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcihcImtleWRvd25cIiwgdGhpcy5ib3VuZEtleURvd24pO1xuXHRcdHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKFwia2V5dXBcIiwgdGhpcy5ib3VuZEtleVVwKTtcblx0fVxuXG5cdGRpc2FibGVDb250cm9scygpIHtcblx0XHR3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcihcImtleWRvd25cIiwgdGhpcy5ib3VuZEtleURvd24pO1xuXHRcdHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKFwia2V5dXBcIiwgdGhpcy5ib3VuZEtleVVwKTtcblx0fVxuXG5cdGNoYW5nZVNwcml0ZSgpXG5cdHtcblx0XHRpZiAodGhpcy5mcmFtZXMgJSB0aGlzLmZyYW1lU3BlZWQgPT09IDApIHtcblx0XHRcdHRoaXMuY3VycmVudFNwcml0ZSsrO1xuXHRcdFx0aWYgKHRoaXMuY3VycmVudFNwcml0ZSA+PSB0aGlzLnRvdGFsU3ByaXRlcykge1xuXHRcdFx0XHR0aGlzLmN1cnJlbnRTcHJpdGUgPSAwO1xuXHRcdFx0fVxuXHRcdFx0bGV0IG5ld0ltZyA9IG5ldyBJbWFnZSgpO1xuXHRcdFx0bmV3SW1nLnNyYyA9IHRoaXMuSW1hZ2Vfc3JjX3ByZWZpeCArIFwiY29pbl9cIiArIHRoaXMuY3VycmVudFNwcml0ZSArIFwiLnBuZ1wiO1xuXHRcdFx0dGhpcy5pbWFnZSA9IG5ld0ltZztcblx0XHR9XG5cdFx0dGhpcy5mcmFtZXMgPSAodGhpcy5mcmFtZXMgKyAxKSAlIDEwMDA7XG5cdH1cblxuXG5cdHVwZGF0ZSgpIHtcblx0XHRjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuXHRcdGlmIChub3cgLSB0aGlzLmxhc3RUaW1lID49IDEwMDAgJiYgdGhpcy50aW1lciA8IDMwMCAmJiAhdGhpcy5HYW1lSXNQYXVzZWQpIHsgLy8g4o+x77iPIHVuZSBzZWNvbmRlIGVzdCBwYXNzw6llLCBldCBtYXggNSBtaW4gKDMwMCBzKVxuXHRcdFx0dGhpcy50aW1lcisrO1xuXHRcdFx0dGhpcy5sYXN0VGltZSA9IG5vdztcblx0XHRcdGNvbnNvbGUubG9nKFwiVGltZXI6XCIsIHRoaXMudGltZXIpO1xuXG5cdFx0XHRpZiAodGhpcy50aW1lciA+PSAyOTApXG5cdFx0XHRcdHRoaXMuZW5kX2NvbWUgPSB0cnVlOyAvLyDij7HvuI8gZmluIGR1IHRpbWVyXG5cdFx0XHRlbHNlXG5cdFx0XHRcdHRoaXMuZW5kX2NvbWUgPSBmYWxzZTsgLy8g4o+x77iPIGZpbiBkdSB0aW1lclxuXG5cdFx0XHRpZiAodGhpcy50aW1lciA+PSAzMDApIHtcblx0XHRcdFx0Y29uc29sZS5sb2coXCJUaW1lciBmaW5pc2hlZFwiKTtcblx0XHRcdFx0dGhpcy50aW1lciA9IDA7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0dGhpcy5jaGFuZ2VTcHJpdGUoKTtcblx0XHR0aGlzLmRyYXcoKTtcblx0XHR0aGlzLmRyYXdfY2FudmFzKCk7XG5cdFx0aWYgKHRoaXMuR2FtZUlzUGF1c2VkKSB7XG5cdFx0XHR0aGlzLmRyYXdfbWVudV9wYXVzZSgpO1xuXHRcdH1cblx0fVxuXG5cdGRyYXdfY2FudmFzKCkge1xuXHRcdC8vIGlmICh0aGlzLmNvaW5faWNvbl9sb2FkZWQgJiYgIXRoaXMuY29pbl9pY29uX2Vycm9yKSB7XG5cdFx0Ly8gXHRjLmRyYXdJbWFnZSh0aGlzLmNvaW5faWNvbiwgOCwgOCwgMzAsIDMwKTtcblx0XHQvLyB9IGVsc2Uge1xuXHRcdC8vIFx0Y29uc29sZS5lcnJvcihcIkNvaW4gaWNvbiBub3QgbG9hZGVkXCIpO1xuXHRcdC8vIH1cblx0XHQvLyBjb25zb2xlLmxvZyhcIkNvaW4gaWNvbiBsb2FkZWQ6XCIsIHRoaXMuY29pbl9pY29uX2xvYWRlZCk7XG5cdFx0Ly8gY29uc29sZS5sb2coXCJuYl9jb2luOlwiLCB0aGlzLm5iX2NvaW4pO1xuXHRcdHRoaXMuZW5hYmxlQ29udHJvbHMoKTtcblx0XHRpZiAodGhpcy50aW1lcl9pY29uX2xvYWRlZCAmJiAhdGhpcy50aW1lcl9pY29uX2Vycm9yKSB7XG5cdFx0XHRjLmRyYXdJbWFnZSh0aGlzLnRpbWVyX2ljb24sIDMsIDUwLCA0MCwgNDApO1xuXHRcdH1cblx0XHRlbHNlIHtcblx0XHRcdGNvbnNvbGUuZXJyb3IoXCJUaW1lciBpY29uIG5vdCBsb2FkZWRcIik7XG5cdFx0fVxuXG5cblx0XHR0aGlzLm5iX2NvaW5fdGV4dCA9IHRoaXMubmJfY29pbiArIFwiIC8gM1wiO1xuXG5cdFx0Yy5maWxsU3R5bGUgPSBcImdvbGRcIjtcblx0XHRjLmZvbnQgPSBcIjIwcHggJ1ByZXNzIFN0YXJ0IDJQJywgQmxhY2sgT3BzIE9uZVwiO1xuXHRcdGMuZmlsbFRleHQodGhpcy5uYl9jb2luX3RleHQsIDcwLCAzMCk7XG5cblx0XHR0aGlzLnRpbWVyX3RleHQgPSB0aGlzLnRpbWVyICsgXCIgc1wiO1xuXHRcdGlmICh0aGlzLmVuZF9jb21lKSB7XG5cdFx0XHRjLmZpbGxTdHlsZSA9IFwicmVkXCI7XG5cdFx0fVxuXHRcdGVsc2Uge1xuXHRcdFx0Yy5maWxsU3R5bGUgPSBcIndoaXRlXCI7XG5cdFx0fVxuXHRcdGMuZm9udCA9IFwiMjBweCAnUHJlc3MgU3RhcnQgMlAnLCBCbGFjayBPcHMgT25lXCI7XG5cdFx0Yy5maWxsVGV4dCh0aGlzLnRpbWVyX3RleHQsIDcwLCA3NSk7XG5cdH1cblxuXHRkcmF3X21lbnVfcGF1c2UoKSB7XG5cdFx0Yy5zYXZlKCk7IC8vIPCflKUgU2F1dmVnYXJkZSBsJ8OpdGF0IGFjdHVlbCBkdSBjYW52YXNcblx0XHRjLmZpbGxTdHlsZSA9IFwicmdiYSgwLCAwLCAwLCAwLjUpXCI7XG5cdFx0Yy5maWxsUmVjdCgwLCAwLCBjYW52YXMud2lkdGgsIGNhbnZhcy5oZWlnaHQpO1xuXHRcdGMuZm9udCA9IFwiMjBweCAnUHJlc3MgU3RhcnQgMlAnLCBCbGFjayBPcHMgT25lXCI7XG5cdFx0Yy50ZXh0QWxpZ24gPSBcImxlZnRcIjtcblx0XHRjLmZpbGxTdHlsZSA9IFwiI0ZGRDcwMFwiO1xuXHRcdGMuc2hhZG93Q29sb3IgPSBcIiMwMDBcIjtcblx0XHRjLnNoYWRvd0JsdXIgPSAxMDtcblx0XHRjLmZpbGxUZXh0KFwiUGF1c2VcIiwgNDgwLCA1MCk7XG5cblx0XHRjLmZpbGxTdHlsZSA9IFwicmVkXCI7XG5cdFx0Yy5mb250ID0gXCIyMHB4ICdQcmVzcyBTdGFydCAyUCcsIEJsYWNrIE9wcyBPbmVcIjtcblx0XHRjLmZpbGxUZXh0KFwiTWVudVwiLCA5MDAsIDU1MCk7XG5cdFx0Yy5maWxsU3R5bGUgPSBcIndoaXRlXCI7XG5cdFx0Yy5yZXN0b3JlKCk7IC8vIPCflKUgUmVzdGF1cmUgbCfDqXRhdCBkdSBjYW52YXNcblx0fVxuXG5cdHJlc2V0R2FtZSgpIHtcblx0XHR0aGlzLm5iX2NvaW4gPSAwO1xuXHRcdHRoaXMubmJfY29pbl90ZXh0ID0gdGhpcy5uYl9jb2luICsgXCIgLyAzXCI7XG5cdFx0dGhpcy50aW1lciA9IDA7XG5cdFx0dGhpcy50aW1lcl90ZXh0ID0gdGhpcy50aW1lcjtcblx0XHR0aGlzLmxhc3RUaW1lID0gRGF0ZS5ub3coKTsgLy8g4o+x77iPIGluaXQgZHUgdGltZXJcblx0XHR0aGlzLmVuZF9jb21lID0gZmFsc2U7IC8vIOKPse+4jyBmaW4gZHUgdGltZXJcblx0fVxuXG5cblx0aGFuZGxlS2V5RG93bihldmVudCkge1xuXHRcdGNvbnN0IGtleSA9IGV2ZW50LmtleTtcblx0XHRpZiAodGhpcy5rZXlQcmVzc2VkW2tleV0pIHJldHVybjtcblx0XHR0aGlzLmtleVByZXNzZWRba2V5XSA9IHRydWU7XG5cblx0XHRzd2l0Y2ggKGtleSkge1xuXHRcdFx0Y2FzZSBcIkFycm93VXBcIjpcblx0XHRcdGNhc2UgXCJ3XCI6XG5cdFx0XHRcdHRoaXMuc2VsZWN0ZWRPcHRpb24gPSAodGhpcy5zZWxlY3RlZE9wdGlvbiAtIDEgKyB0aGlzLm9wdGlvbnMubGVuZ3RoKSAlIHRoaXMub3B0aW9ucy5sZW5ndGg7XG5cdFx0XHRcdGJyZWFrO1xuXHRcdFx0Y2FzZSBcIkFycm93RG93blwiOlxuXHRcdFx0Y2FzZSBcInNcIjpcblx0XHRcdFx0dGhpcy5zZWxlY3RlZE9wdGlvbiA9ICh0aGlzLnNlbGVjdGVkT3B0aW9uICsgMSkgJSB0aGlzLm9wdGlvbnMubGVuZ3RoO1xuXHRcdFx0XHRicmVhaztcblx0XHRcdGNhc2UgXCJFbnRlclwiOlxuXHRcdFx0XHRpZiAodGhpcy5HYW1lSXNQYXVzZWQpIHtcblx0XHRcdFx0XHR0aGlzLmhhbmRsZVNlbGVjdCgpO1xuXHRcdFx0XHR9XG5cdFx0XHRcdGJyZWFrO1xuXHRcdFx0Y2FzZSBcIkVzY2FwZVwiOlxuXHRcdFx0XHRpZiAoZ2FtZVN0YXRlLmN1cnJlbnQgPT09IEdhbWVTdGF0ZS5QbGF5KSB7XG5cdFx0XHRcdFx0dGhpcy5HYW1lSXNQYXVzZWQgPSAhdGhpcy5HYW1lSXNQYXVzZWQ7XG5cdFx0XHRcdFx0aWYgKHRoaXMuR2FtZUlzUGF1c2VkKSB7XG5cdFx0XHRcdFx0XHRjb25zb2xlLmxvZyhcIkdhbWUgcGF1c2VkXCIpO1xuXHRcdFx0XHRcdFx0dGhpcy5kaXNhYmxlQ29udHJvbHMoKTtcblx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0Y29uc29sZS5sb2coXCJHYW1lIHJlc3VtZWRcIik7XG5cdFx0XHRcdFx0XHR0aGlzLmVuYWJsZUNvbnRyb2xzKCk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cdFx0XHRcdGJyZWFrO1xuXHRcdH1cblx0fVxuXG5cdGhhbmRsZUtleVVwKGV2ZW50KSB7XG5cdFx0dGhpcy5rZXlQcmVzc2VkW2V2ZW50LmtleV0gPSBmYWxzZTtcblx0fVxuXG5cdGhhbmRsZVNlbGVjdCgpXG5cdHtcblx0XHRjb25zdCBzZWxlY3RlZCA9IHRoaXMub3B0aW9uc1t0aGlzLnNlbGVjdGVkT3B0aW9uXTtcblx0XHRpZiAoc2VsZWN0ZWQgPT09IFwiTWVudVwiKVxuXHRcdHtcblx0XHRcdHRoaXMuZGlzYWJsZUNvbnRyb2xzKCk7XG5cdFx0XHR0aGlzLnJlc2V0R2FtZSgpO1xuXHRcdFx0dGhpcy5wbGF5ZXIucmVzZXRfR2FtZSgpO1xuXHRcdFx0dGhpcy5HYW1lSXNQYXVzZWQgPSBmYWxzZTtcblx0XHRcdGdhbWVTdGF0ZS5wcmV2aW91cyA9IGdhbWVTdGF0ZS5jdXJyZW50O1xuXHRcdFx0Z2FtZVN0YXRlLmN1cnJlbnQgPSBHYW1lU3RhdGUuTWVudTtcblx0XHR9XG5cdH1cbn0iXX0=